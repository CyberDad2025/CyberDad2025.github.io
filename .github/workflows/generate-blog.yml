name: Generate Daily Cybersecurity Blog Post with Affiliates

on:
  schedule:
    schedule:
    - cron: '0 5 * * *'   # Daily at midnight EST
    - cron: '0 13 * * *'  # 8:00 AM EST - morning content
    - cron: '0 21 * * *'  # 4:00 PM EST - afternoon content
  workflow_dispatch:

jobs:
  generate-affiliate-blog-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Generate blog content with affiliate targeting
      id: generate
      run: |
        DATE=$(date +%Y-%m-%d)
        TIMESTAMP=$(date +%s)
        
        # High-value cybersecurity topics with affiliate potential
        TOPICS=(
          "Best VPN Services for Family Protection 2025"
          "Password Manager Comparison for Parents"
          "Home Router Security Setup Guide"
          "Business Antivirus Solutions Review"
          "Cloud Backup Security for Families"
          "Parental Control Software Comparison"
          "Identity Theft Protection Services"
          "Enterprise Security Tools for Small Business"
          "Secure Email Services for Privacy"
          "Cryptocurrency Wallet Security Guide"
          "Smart Home Security Systems Review"
          "Mobile Device Management Solutions"
          "Network Monitoring Tools for Parents"
          "Data Recovery Software Comparison"
          "Firewall Solutions for Home Office"
          "Two-Factor Authentication Apps Review"
          "Secure File Sharing Services"
          "Privacy VPN for Streaming Safely"
          "Business Email Security Solutions"
          "Cybersecurity Training Platforms"
        )
        
        TOPIC=${TOPICS[$RANDOM % ${#TOPICS[@]}]}
        
        # Generate content with affiliate link opportunities
        CONTENT=$(curl -X POST https://api.openai.com/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
          -d '{
            "model": "gpt-4",
            "messages": [
              {
                "role": "system",
                "content": "You are a cybersecurity expert writing for busy parents and small business owners. Write actionable content that naturally mentions specific product categories (VPNs, antivirus, password managers, etc.) that readers should consider. Include specific scenarios where these tools help. Write 300-400 words."
              },
              {
                "role": "user",
                "content": "Write a comprehensive blog post about: '"$TOPIC"'. Include practical recommendations and mention when readers should consider specific cybersecurity tools. Focus on real-world benefits and peace of mind for families/businesses."
              }
            ],
            "max_tokens": 500,
            "temperature": 0.7
          }' | jq -r '.choices[0].message.content')
        
        # Define affiliate links based on content topic
        VPN_LINK="https://nordvpn.com/cyberdad"
        ANTIVIRUS_LINK="https://norton.com/cyberdad"
        PASSWORD_LINK="https://1password.com/cyberdad"
        BACKUP_LINK="https://backblaze.com/cyberdad"
        
        # Smart affiliate link insertion based on topic keywords
        AFFILIATE_SECTION=""
        if [[ "$TOPIC" == *"VPN"* ]] || [[ "$TOPIC" == *"Privacy"* ]]; then
          AFFILIATE_SECTION="<p><strong>üîí Recommended VPN:</strong> <a href=\"$VPN_LINK\" target=\"_blank\" rel=\"nofollow\">Get NordVPN (30-day money-back guarantee)</a></p>"
        elif [[ "$TOPIC" == *"Antivirus"* ]] || [[ "$TOPIC" == *"Malware"* ]]; then
          AFFILIATE_SECTION="<p><strong>üõ°Ô∏è Recommended Security:</strong> <a href=\"$ANTIVIRUS_LINK\" target=\"_blank\" rel=\"nofollow\">Norton 360 Family Protection</a></p>"
        elif [[ "$TOPIC" == *"Password"* ]]; then
          AFFILIATE_SECTION="<p><strong>üîë Recommended Password Manager:</strong> <a href=\"$PASSWORD_LINK\" target=\"_blank\" rel=\"nofollow\">1Password Family Plan</a></p>"
        elif [[ "$TOPIC" == *"Backup"* ]] || [[ "$TOPIC" == *"Data"* ]]; then
          AFFILIATE_SECTION="<p><strong>üíæ Recommended Backup:</strong> <a href=\"$BACKUP_LINK\" target=\"_blank\" rel=\"nofollow\">Backblaze Unlimited Backup</a></p>"
        else
          # Default to VPN for general security topics
          AFFILIATE_SECTION="<p><strong>üîí Essential Security Tool:</strong> <a href=\"$VPN_LINK\" target=\"_blank\" rel=\"nofollow\">Secure your family with NordVPN</a></p>"
        fi
        
        # Create HTML with enhanced affiliate content
        cat > "cyber_${DATE}_${TIMESTAMP}.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <!-- MailerLite Universal -->
            <script>
            (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
            .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
            n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
            (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
            ml('account', '1632070');
            </script>
            <!-- End MailerLite Universal -->
            
            <meta charset="UTF-8">
            <title>$TOPIC | Cyber Dad Blog</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
                header { background: #1d3557; color: white; padding: 20px 40px; text-align: center; }
                main { padding: 40px; max-width: 800px; margin: auto; background: white; }
                article { margin-bottom: 40px; }
                h2 { color: #1d3557; }
                .cta { display: inline-block; background: #457b9d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 10px; }
                .affiliate-rec { background: #e8f4f8; padding: 15px; border-left: 4px solid #457b9d; margin: 20px 0; }
                .affiliate-rec a { color: #1d3557; font-weight: bold; }
                footer { text-align: center; padding: 20px; background: #eaeaea; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <header>
                <h1>üîê $TOPIC</h1>
            </header>
            
            <main>
                <article>
                    $CONTENT
                    
                    <div class="affiliate-rec">
                        $AFFILIATE_SECTION
                    </div>
                    
                    <p><a href="https://www.etsy.com/shop/CyberDadPrints" target="_blank" class="cta">Get Our Complete Family Security Toolkit</a></p>
                </article>
                
                <h2>üåç Global Cybersecurity Protection</h2>
                <p>Cyber threats are borderless. Whether you're in New York, London, Tokyo, or Sydney, your family needs protection.</p>
                
                <p><strong>Why international families trust our recommendations:</strong></p>
                <ul>
                    <li>üîí Global VPN server coverage</li>
                    <li>üõ°Ô∏è Multi-language security software</li>
                    <li>üì± Cross-platform compatibility</li>
                    <li>üåê 24/7 international support</li>
                </ul>
                
                <p>Join over 50,000 families worldwide who've secured their digital lives with our trusted recommendations.</p>
                
                <p><a href="https://www.etsy.com/shop/CyberDadPrints" target="_blank" class="cta">Start Your Family Security Journey</a></p>
                
                <p><em>#CyberSecurity #FamilyProtection #GlobalSafety #DigitalParenting</em></p>
            </main>
        </body>
        </html>
        EOF
        
        echo "filename=cyber_${DATE}_${TIMESTAMP}.html" >> $GITHUB_OUTPUT
        echo "topic=$TOPIC" >> $GITHUB_OUTPUT
    
    - name: Update index.html with new post
      run: |
        FILENAME="${{ steps.generate.outputs.filename }}"
        TOPIC="${{ steps.generate.outputs.topic }}"
        
        # Update homepage with new content
        cat > temp_index.html << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <!-- MailerLite Universal -->
            <script>
            (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
            .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
            n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
            (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
            ml('account', '1632070');
            </script>
            <!-- End MailerLite Universal -->
            
            <meta charset="UTF-8">
            <title>Cyber Dad Blog | Global Family Cybersecurity</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
                header { background: #1d3557; color: white; padding: 20px 40px; text-align: center; }
                main { padding: 40px; max-width: 800px; margin: auto; background: white; }
                article { margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
                h2 { color: #1d3557; }
                .cta { display: inline-block; background: #457b9d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 10px; }
                .affiliate-rec { background: #e8f4f8; padding: 15px; border-left: 4px solid #457b9d; margin: 20px 0; }
                .affiliate-rec a { color: #1d3557; font-weight: bold; }
            </style>
        </head>
        <body>
            <header>
                <h1>Cyber Dad Blog</h1>
                <p>Global Cybersecurity Guidance for Modern Families</p>
            </header>
            
            <main>
        EOF
        
        # Add new post content
        sed -n '/<main>/,/<\/main>/p' "$FILENAME" | sed '1d;$d' >> temp_index.html
        
        # Add existing content (limit to last 5 posts for performance)
        if [ -f index.html ]; then
            sed -n '/<main>/,/<\/main>/p' index.html | sed '1d;$d' | sed '0,/<\/article>/d' | head -n 100 >> temp_index.html
        fi
        
        cat >> temp_index.html << EOF
            </main>
        </body>
        </html>
        EOF
        
        mv temp_index.html index.html
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Add affiliate cybersecurity post: ${{ steps.generate.outputs.topic }}" || exit 0
        git push
